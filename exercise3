create database BankSystem;
use BankSystem;

create table accounts (
	accountID int not null primary key auto_increment,
    balance decimal (10,2)
);
create table transactions (
	transactionID int not null primary key auto_increment,
    fromAccountID int not null,
    toAccountId int not null,
    amount decimal ( 10,2),
    transactionDate datetime,
    foreign key (fromAccountID) references accounts (accountID),
	foreign key (toAccountId) references accounts (accountID)
);

insert into accounts (balance) 
values 
(5000.00),
(3000.00),
(12000.00);	
		
CREATE TABLE budgets (
    budgetID INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    accountID INT NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    month VARCHAR(20),
    FOREIGN KEY (accountID) REFERENCES accounts(accountID)
);

CREATE TABLE expenses (
    expenseID INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    accountID INT NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    expenseDate DATETIME,
    description VARCHAR(255),
    FOREIGN KEY (accountID) REFERENCES accounts(accountID)
);


CREATE TABLE transactionHistory (
    historyID INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    transactionID INT NULL,
    accountID INT NOT NULL,
    amount DECIMAL(10,2),
    transactionDate DATETIME,
    type VARCHAR(50),

    FOREIGN KEY (transactionID) REFERENCES transactions(transactionID),
    FOREIGN KEY (accountID) REFERENCES accounts(accountID)
);

DELIMITER $$

CREATE PROCEDURE sp_log_transaction(
    IN p_transactionID INT
)
BEGIN
    DECLARE v_from INT;
    DECLARE v_to INT;
    DECLARE v_amount DECIMAL(10,2);
    
    SELECT fromAccountID, toAccountID, amount
    INTO v_from, v_to, v_amount
    FROM transactions
    WHERE transactionID = p_transactionID;

    INSERT INTO transactionHistory (transactionID, accountID, amount, transactionDate, type)
    VALUES (p_transactionID, v_from, v_amount, NOW(), 'TRANSFER_OUT');
    
    INSERT INTO transactionHistory (transactionID, accountID, amount, transactionDate, type)
    VALUES (p_transactionID, v_to, v_amount, NOW(), 'TRANSFER_IN');
END $$

DELIMITER ;

DELIMITER $$

CREATE TRIGGER trg_after_transaction_insert
AFTER INSERT ON transactions
FOR EACH ROW
BEGIN
    CALL sp_log_transaction(NEW.transactionID);
END $$

DELIMITER ;



